<!doctype html>
<html lang="ko">
<head>
  <link rel="icon" type="image/png" href="/public/favicon.png" />
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title><%= mode === "new" ? "New Offer" : "Edit Offer" %> - <%= siteName %></title>
  <link rel="stylesheet" href="/public/styles.css" />
</head>
<body>
  <header class="topbar">
    <div class="wrap topbar-inner topbar-3col">
      <div class="top-left">
        <a class="brand brand-logo" href="/">
          <img src="/public/logo.png" alt="SNF CORPORATION" />
        </a>
      </div>
      <nav class="top-center"><a class="navlink" href="/offers">OFFERS</a></nav>
      <div class="top-right"><a class="link" href="/admin">ADMIN</a></div>
    </div>
  </header>

  <main class="wrap">
    <h1><%= mode === "new" ? "오퍼 작성" : "오퍼 수정" %></h1>

    <% if (typeof uploadError !== "undefined" && uploadError) { %>
      <div class="alert"><%= uploadError %></div>
    <% } %>

    <!-- ✅ 저장 FORM (단 1개만) -->
    <form class="form"
          method="post"
          enctype="multipart/form-data"
          action="<%= mode === 'new' ? '/admin/new' : ('/admin/edit/' + post.id) %>">

      <label>제목(리스트에 보일 이름)</label>
      <input name="title" value="<%= post.title || '' %>" required />

      <div class="grid2">
        <div>
          <label>Date</label>
          <input name="date" value="<%= (post.offer?.date)||'' %>" placeholder="2025-12-25" />
        </div>
        <div>
          <label>Invoice No.</label>
          <input name="invoice_no" value="<%= (post.offer?.invoice_no)||'' %>" placeholder="SNFMD51225-00A" />
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>Destination</label>
          <input name="destination" value="<%= (post.offer?.destination)||'' %>" placeholder="HONG KONG" />
        </div>
        <div>
          <label>Price Terms</label>
          <input name="price_terms" value="<%= (post.offer?.price_terms)||'' %>" placeholder="EX-W Korea" />
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>Payment</label>
          <input name="payment" value="<%= (post.offer?.payment)||'' %>" />
        </div>
        <div>
          <label>Shipment</label>
          <input name="shipment" value="<%= (post.offer?.shipment)||'' %>" />
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>Origin</label>
          <input name="origin" value="<%= (post.offer?.origin)||'' %>" placeholder="Republic of Korea" />
        </div>
        <div>
          <label>Packing</label>
          <input name="packing" value="<%= (post.offer?.packing)||'' %>" />
        </div>
      </div>

      <label>Part Information</label>
      <textarea name="bank_info" rows="4"><%= (post.offer?.bank_info)||'' %></textarea>

      <hr style="margin:16px 0;">

      <div style="display:flex; align-items:end; justify-content:space-between; gap:12px;">
        <h2 style="margin:0;">Items</h2>
        <div class="hint" style="margin:0;">* Unit Price는 USD 기준</div>
      </div>

      <table class="table">
        <thead>
          <tr>
            <th style="width:70px;">No.</th>
            <th>Description</th>
            <th style="width:140px;">Qty</th>
            <th style="width:170px;">Unit Price (USD)</th>
          </tr>
        </thead>
        <tbody id="itemsBody">
          <% const items = (post.offer?.items && post.offer.items.length) ? post.offer.items : [{desc:"", qty:"", unit:""}]; %>
          <% items.forEach((it, idx) => { %>
            <tr>
              <td><%= idx+1 %></td>
              <td><input name="item_desc[]" value="<%= it.desc || '' %>" placeholder="Commodity & Description" /></td>
              <td><input type="number" step="any" name="item_qty[]" value="<%= it.qty || '' %>" placeholder="4000" /></td>
              <td><input type="number" step="any" name="item_unit[]" value="<%= it.unit || '' %>" placeholder="171.00" /></td>
            </tr>
          <% }) %>
        </tbody>
      </table>

      <div class="row" style="margin-top:10px;">
        <button class="btn secondary" type="button" onclick="addRow()">+ Add Item</button>
      </div>

      <!-- ✅ 첨부파일 업로드(저장 눌러야 반영) -->
      <hr style="margin:16px 0;">
      <label>첨부파일(PDF 등)</label>
      <input type="file" name="attachment" accept=".pdf,.png,.jpg,.jpeg" />
      <div class="hint">* 최대 20MB (업로드 후 저장을 눌러야 반영됩니다)</div>

      <label style="margin-top:16px;">Bank Information</label>
      <textarea name="offer_note" rows="5"><%= post.offer_note || '' %></textarea>

      <label>공개 여부</label>
      <!-- ✅ value를 "1"/"0" 로 고정 (NaN 방지 핵심) -->
      <select name="is_published">
        <option value="1" <%= Number(post.is_published) === 1 ? "selected" : "" %>>공개(올리기)</option>
        <option value="0" <%= Number(post.is_published) === 0 ? "selected" : "" %>>비공개(숨기기)</option>
      </select>

      <div class="row">
        <button class="btn" type="submit">저장</button>
        <a class="btn secondary" href="/admin">취소</a>
      </div>
    </form>

    <!-- ✅ 첨부파일 목록/삭제는 "저장 form 밖"에서 표시 (중첩 form 제거 핵심) -->
    <% if (mode === "edit") { %>
      <div style="margin-top:18px;">
        <h3 style="margin:0 0 8px 0;">첨부파일 목록</h3>

        <% if (attachments && attachments.length) { %>
          <ul style="margin:0; padding-left:18px;">
            <% attachments.forEach(f => { %>
              <li style="margin:6px 0;">
                <a href="/attachment/<%= f.id %>"><%= f.filename %></a>
                (<%= Math.round(f.size/1024) %> KB)
                <form method="post"
                      action="/admin/attachment/delete/<%= f.id %>"
                      style="display:inline;"
                      onsubmit="return confirm('첨부파일을 삭제할까요?');">
                  <button class="btn tiny danger" type="submit">삭제</button>
                </form>
              </li>
            <% }) %>
          </ul>
        <% } else { %>
          <div class="hint">첨부파일이 없습니다.</div>
        <% } %>
      </div>
    <% } %>
  </main>

  <script>
    function addRow(){
      const body = document.getElementById('itemsBody');
      const n = body.children.length + 1;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${n}</td>
        <td><input name="item_desc[]" placeholder="Commodity & Description" /></td>
        <td><input type="number" step="any" name="item_qty[]" placeholder="4000" /></td>
        <td><input type="number" step="any" name="item_unit[]" placeholder="171.00" /></td>
      `;
      body.appendChild(tr);
    }
  </script>
</body>
</html>